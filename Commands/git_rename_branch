#!/usr/bin/env bash

# Safely rename a git branch both locally and remotely
# Usage: git_rename_branch <old_name> <new_name>

set -e

old_name="$1"
new_name="$2"

# Check arguments
if [ -z "$old_name" ] || [ -z "$new_name" ]; then
    echo "Usage: git_rename_branch <old_name> <new_name>" >&2
    exit 1
fi

# Check if we are in a git repository
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
    echo "Error: Not in a git repository" >&2
    exit 1
fi

# Get the remote name (usually origin)
remote=$(git remote | head -n1)
if [ -z "$remote" ]; then
    echo "Warning: No remote configured. Will only rename local branch."
    has_remote=false
else
    has_remote=true
fi

# Check if new branch already exists locally
if git show-ref --verify --quiet "refs/heads/$new_name"; then
    echo "Error: Local branch '$new_name' already exists" >&2
    exit 1
fi

# Refresh remotes before checking remote refs
if [ "$has_remote" = true ]; then
    git fetch "$remote" --prune &>/dev/null || true
fi

# Check if new branch already exists on remote
if [ "$has_remote" = true ]; then
    if git show-ref --verify --quiet "refs/remotes/$remote/$new_name"; then
        echo "Error: Remote branch '$remote/$new_name' already exists" >&2
        exit 1
    fi
fi

# Ensure old branch exists locally; if not, try to pull from remote
if ! git show-ref --verify --quiet "refs/heads/$old_name"; then
    if [ "$has_remote" = true ] && git show-ref --verify --quiet "refs/remotes/$remote/$old_name"; then
        git branch "$old_name" "$remote/$old_name"
        echo "Created local branch '$old_name' from '$remote/$old_name'"
    else
        echo "Error: Local branch '$old_name' does not exist" >&2
        exit 1
    fi
fi

# Get current branch
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# Rename local branch
if [ "$current_branch" = "$old_name" ]; then
    git branch -m "$new_name"
    echo "Renamed current branch from '$old_name' to '$new_name'"
else
    git branch -m "$old_name" "$new_name"
    echo "Renamed local branch from '$old_name' to '$new_name'"
fi

# Handle remote branch if remote exists
if [ "$has_remote" = true ]; then
    if git show-ref --verify --quiet "refs/remotes/$remote/$old_name"; then
        # Push explicitly to the new remote ref and set upstream in one step.
        git push -u "$remote" "$new_name:refs/heads/$new_name"
        echo "Pushed '$new_name' to $remote and set upstream"
        git push "$remote" --delete "$old_name"
        echo "Deleted '$old_name' from $remote"
    else
        # If the old branch doesn't exist remotely, still publish the new branch.
        git push -u "$remote" "$new_name:refs/heads/$new_name"
        echo "Pushed '$new_name' to $remote and set upstream"
    fi
fi

echo "Branch rename complete!"
